---
title: "IntentionBehaviorGap"
author: "Yejin Hwang"
date: "3/7/2019"
output: pdf_document
---

```{r}
library(tidyverse)
library(haven) #haven is part of tidyverse, but for some reason, this is needed.
library(ggplot2)
library(cowplot)
library(stargazer)
library(car)
library(knitr) #to enable kable for testing. 
library(lfe) #To use the 'felm' command to run fixed effect linear models with clusterin

data1 <- read_dta("./data/final_data1.dta")
data2 <- read_dta("./data/final_data2.dta")
data3 <- read_dta("./data/final_data3.dta")
```

## Recreating Table 2
```{r table2}
# Read in data file, assign to MyData
MyData <- data1

# Select variables in Table 2 from MyData, put in dataframe d
vars <- c(34, 35, 36, 51, 52)
d <- data1[,vars]
 
# Compute means without missing (NA) values
summary(d)
sapply(d, mean, na.rm=TRUE)
sapply(d, sd, na.rm=TRUE)
```

```{r}
stargazer(data.frame(d), title = "Table 2—Action-Plan Descriptives", omit.summary.stat = c("min", "max", "p25", "p75"), type="text")
```

```{r}
goal_opport <- data1$goal_opport[!is.na(data1$goal_opport)]
goal_submit <- data1$goal_submit[!is.na(data1$goal_submit)]
goal_hours <- data1$goal_hours[!is.na(data1$goal_hours)]
activity_days <- data1$activity_days[!is.na(data1$activity_days)]
APcomplete <- data1$APcomplete[!is.na(data1$APcomplete)]

rownames <- c("Completed AP", "Activity days", "Goal: Job search hours", "Goal: Opportunities to identify", "Goal: Applications to submit")
observations <- c(length(APcomplete), length(activity_days), length(goal_hours), length(goal_opport), length(goal_submit))
mean <- c(mean(APcomplete), mean(activity_days), mean(goal_hours), mean(goal_opport), mean(goal_submit))
sd <- c(sd(APcomplete), sd(activity_days), sd(goal_hours), sd(goal_opport), sd(goal_submit))

table2_brute_force <- data.frame(rownames, observations, mean, sd)
table2_brute_force
```


Note:
windsorized: how they deal with wacky means / outliers
i.e. using x9 to replace x10
use windsor.mean function
may be prewindsorized data

```{r}
#SDH: I added some line breaks below in the call to stargazer, 
#...just a recommendation to make your code more readable -- consider doing it in the later ones too. 
controlGroup <- data1 %>% select(age_yr, female_d, educ_yr)
names(controlGroup) <- c("Age", "Female", "Education (in years)")
stargazer::stargazer(data.frame(controlGroup), 
                     summary.stat = c("n", "mean", "median", "sd"), 
                     type = "text", 
                     title = "Table 1—Sample Characteristics")
```



Tables:
```{r table1}
controlGroup <- data1 %>% select(age_yr, female_d, educ_yr, bs_b15a,moved_yesno_d,bs_b1_ever_job_d,bs_b13_reserv_wage,bs_b14,bs_transport_cost,bs_b16,bs_c2,bs_c3)
stargazer::stargazer(data.frame(controlGroup), summary.stat = c("n", "mean", "median", "sd"), type = "text", title = "Table 1—Sample Characteristics")
```

summary stats: tables 1 and 2
Table 3-Effects on Job Search Intensity. panel-data regression and se. outcome var winsorized=remove extreme values
Table 4-Effects on Employment Outcomes. regression and se.
Table 5-Effects on Frequency of Search-Channel Use

Graphs:
Figure 1. Intention-Behavior Gap: Difference at Baseline - density plot Hours and apps difference: Goal - Baseline

```{r figure1}
hours_diff_density <- ggplot(data1, aes(hours_diff, stat(density))) +
  geom_histogram(fill = "#416b85", bins = 18) +
  labs(x = "Hours difference: Goal - Baseline", y = "Density") +
  ylim(0, 0.15)
apps_diff_density <- ggplot(data1, aes(apps_diff, stat(density))) +
  geom_histogram(fill = "#416b85", bins = 18) +
  labs(x = "Apps difference: Goal - Baseline", y = "Density")
plot_grid(hours_diff_density, apps_diff_density)
ggsave("figure1.jpg")
```

Table 5
```{r}
#data2
#b1_1_t: Empl. agency
#b1_2_t: dropped cv
#b1_3_t: placed ad
#b1_4_t: answered ad
#b1_5_t: searched online
#b1_6_t: Fam./Friends
#b4_t: employer responses

m1_t5 <- felm(b1_1_t ~ ws_d + ws_plus_d + educ_yr + age_yr + female_d + bs_b15a + lang_xhosa_d + lang_venda_d + lang_zulu_d + nomiss_bs_c1_1 + missd_bs_c1_1 + as.factor(location_f) + as.factor(round) | 0 | 0 | id, data = data2)
m2_t5 <- felm(b1_2_t ~ ws_d + ws_plus_d + educ_yr + age_yr + female_d + bs_b15a + lang_xhosa_d + lang_venda_d + lang_zulu_d + nomiss_bs_c1_2 + missd_bs_c1_2 + as.factor(location_f) + as.factor(round) | 0 | 0 | id, data = data2)
m3_t5 <- felm(b1_3_t ~ ws_d + ws_plus_d + educ_yr + age_yr + female_d + bs_b15a + lang_xhosa_d + lang_venda_d + lang_zulu_d + nomiss_bs_c1_3 + missd_bs_c1_3 + as.factor(location_f) + as.factor(round) | 0 | 0 | id, data = data2)
m4_t5 <- felm(b1_4_t ~ ws_d + ws_plus_d + educ_yr + age_yr + female_d + bs_b15a + lang_xhosa_d + lang_venda_d + lang_zulu_d + nomiss_bs_c1_4 + missd_bs_c1_4 + as.factor(location_f) + as.factor(round) | 0 | 0 | id, data = data2)
m5_t5 <- felm(b1_5_t ~ ws_d + ws_plus_d + educ_yr + age_yr + female_d + bs_b15a + lang_xhosa_d + lang_venda_d + lang_zulu_d + nomiss_bs_c1_5 + as.factor(location_f) + as.factor(round) | 0 | 0 | id, data = data2) #missd_bs_c1_5 removed because it generated a coefficent of NaN which made the linearHypothesis test not work. my numbers here still match the paper's though.
m6_t5 <- felm(b1_6_t ~ ws_d + ws_plus_d + educ_yr + age_yr + female_d + bs_b15a + lang_xhosa_d + lang_venda_d + lang_zulu_d + nomiss_bs_c1_6 + as.factor(location_f) + as.factor(round) | 0 | 0 | id, data = data2) #missd_bs_c1_6 removed for same reason
stargazer(m1_t5, m2_t5, m3_t5, m4_t5, m5_t5, m6_t5,
          colnames = FALSE,
          column.labels = c("Empl. agency", "Dropped CV", "Placed ad", "Answered ad", "Searched online", "Fam./friends"),
          keep = c("ws_d", "ws_plus_d"), keep.stat =c("n","rsq"),
          type = "text",
          supress.errors = TRUE,
          title="Table 5—Effects on Frequency of Search-Channel Use",
          add.lines = list(c("p-value", "0.009711**", "0.003649**", "0.5369", "0.003324**", "0.006298 **", "0.786")))

#stargazer type = latex
```

```{r}
#summary mod
linearHypothesis(m1_t5, c("ws_d = ws_plus_d"))
```

```{r}
linearHypothesis(m2_t5, c("ws_d = ws_plus_d"))
```

```{r}
linearHypothesis(m3_t5, c("ws_d = ws_plus_d"))
```

```{r}
linearHypothesis(m4_t5, c("ws_d = ws_plus_d"))
```

```{r}
linearHypothesis(m5_t5, c("ws_d = ws_plus_d"), singular.ok = TRUE)
```

```{r}
linearHypothesis(m6_t5, c("ws_d = ws_plus_d"), singular.ok = TRUE)
```


Table 3:

```{r}
final_data1 <- read_dta("./data/final_data1.dta")
final_data2 <- read_dta("./data/final_data2.dta")
final_data3 <- read_dta("./data/final_data3.dta")
```

```{r table3_reproduction}

#TABLE3

m1_t3 <- lm(b2_t ~ ws_d + ws_plus_d + nomiss_bs_c2 + missd_bs_c2 + as.factor(location_f) + as.factor(round), data = final_data2)
summary(m1_t3)

m2_t3 <- lm(b2_t ~ ws_d + ws_plus_d + nomiss_bs_c2 + missd_bs_c2 +
               educ_yr + age_yr + female_d + bs_b15a + lang_xhosa_d + lang_venda_d + lang_zulu_d +
               as.factor(location_f) + as.factor(round), data = final_data2)
summary(m2_t3)

m3_t3 <- lm(b3_t ~ ws_d + ws_plus_d + nomiss_bs_c3 + missd_bs_c3 + as.factor(location_f) + as.factor(round), data = final_data2)
summary(m3_t3)

m4_t3 <- lm(b3_t ~ ws_d + ws_plus_d + nomiss_bs_c3 + missd_bs_c3 +
               educ_yr + age_yr + female_d + bs_b15a + lang_xhosa_d + lang_venda_d + lang_zulu_d +
               as.factor(location_f) + as.factor(round), data = final_data2)
summary(m4_t3)

stargazer(m1_t3,m2_t3,m3_t3,m4_t3, keep=c("ws_d","ws_plus_d"), keep.stat = c("n","rsq"), type = "text", column.labels = c("Search Hours", "Search Hours", "Applications", "Applications"), covariate.labels =c("WS basic", "WS plus"), title="Table 3--EFFECTS ON JOB SEARCH INTENSITY",
          add.lines = 
            list(c("Covariates", "No", "Yes", "No", "Yes"),
                  c("p-value", "0.7109","0.4656", "0.0002516 ***", "0.0008659 ***")))
#na.rm=TRUE
```



```{r table3_reproduction}

#TABLE3

m1_t3cluster <- lm.cluster(b2_t ~ ws_d + ws_plus_d + nomiss_bs_c2 + missd_bs_c2 + as.factor(location_f) + as.factor(round), data = final_data2, cluster = "id")
summary(m1_t3cluster)


m2_t3 <- lm(b2_t ~ ws_d + ws_plus_d + nomiss_bs_c2 + missd_bs_c2 +
               educ_yr + age_yr + female_d + bs_b15a + lang_xhosa_d + lang_venda_d + lang_zulu_d +
               as.factor(location_f) + as.factor(round), data = final_data2)
summary(m2_t3)

m3_t3 <- lm(b3_t ~ ws_d + ws_plus_d + nomiss_bs_c3 + missd_bs_c3 + as.factor(location_f) + as.factor(round), data = final_data2)
summary(m3_t3)

m4_t3 <- lm(b3_t ~ ws_d + ws_plus_d + nomiss_bs_c3 + missd_bs_c3 +
               educ_yr + age_yr + female_d + bs_b15a + lang_xhosa_d + lang_venda_d + lang_zulu_d +
               as.factor(location_f) + as.factor(round), data = final_data2)
summary(m4_t3)


#kable(m1_t3cluster$vcov[2])

stargazer(m1_t3cluster$lm_res[1],m2_t3,m3_t3,m4_t3, keep=c("ws_d","ws_plus_d"), keep.stat = c("n","rsq"), type = "text", column.labels = c("Search Hours", "Search Hours", "Applications", "Applications"), covariate.labels =c("WS basic", "WS plus"), title="Table 3--EFFECTS ON JOB SEARCH INTENSITY",
          add.lines = 
            list(c("Covariates", "No", "Yes", "No", "Yes"),
                  c("p-value", "0.7109","0.4656", "0.0002516 ***", "0.0008659 ***")))
#na.rm=TRUE
```



```{r simon_testing}

#Notice here I'm using 'felm' instead of 'lm' or 'lm.cluster'. 
#felm apparently reports a better structured object that can be more easily passed to stargazer (see below)
#I did get some errors, but it seems to work as specified. 
m1t3c <- felm(b2_t ~ ws_d + ws_plus_d + nomiss_bs_c2 + missd_bs_c2 +
                      as.factor(location_f) + as.factor(round) |0|0| id, 
                    data = final_data2)
#summary(m1t3c)
m2t3c <- felm(b2_t ~ ws_d + ws_plus_d + nomiss_bs_c2 + missd_bs_c2 +
               educ_yr + age_yr + female_d + bs_b15a + lang_xhosa_d + 
                 lang_venda_d + lang_zulu_d +
               as.factor(location_f) + as.factor(round)  |0|0| id, 
               data = final_data2)
m3t3c <- felm(b3_t ~ ws_d + ws_plus_d + nomiss_bs_c3 + missd_bs_c3 +
                      as.factor(location_f) + as.factor(round)  |0|0| id, 
                    data = final_data2)
m4t3c <- felm(b3_t ~ ws_d + ws_plus_d + nomiss_bs_c3 + missd_bs_c3 +
               educ_yr + age_yr + female_d + bs_b15a + lang_xhosa_d + 
                 lang_venda_d + lang_zulu_d +
               as.factor(location_f) + as.factor(round)  |0|0| id, 
               data = final_data2)
summary(m2t3c)

# m1t3c <- lm.cluster(b2_t ~ ws_d + ws_plus_d + nomiss_bs_c2 + missd_bs_c2 +
#                       as.factor(location_f) + as.factor(round), 
#                     data = final_data2, cluster = "id")
# m2t3c <- lm.cluster(b2_t ~ ws_d + ws_plus_d + nomiss_bs_c2 + missd_bs_c2 +
#                educ_yr + age_yr + female_d + bs_b15a + lang_xhosa_d + 
#                  lang_venda_d + lang_zulu_d +
#                as.factor(location_f) + as.factor(round), 
#                data = final_data2, cluster = "id")
# m3t3c <- lm.cluster(b3_t ~ ws_d + ws_plus_d + nomiss_bs_c3 + missd_bs_c3 +
#                       as.factor(location_f) + as.factor(round), 
#                     data = final_data2, cluster = "id")
# m4t3c <- lm.cluster(b3_t ~ ws_d + ws_plus_d + nomiss_bs_c3 + missd_bs_c3 +
#                educ_yr + age_yr + female_d + bs_b15a + lang_xhosa_d + 
#                  lang_venda_d + lang_zulu_d +
#                as.factor(location_f) + as.factor(round), 
#                data = final_data2, cluster = "id")

stargazer(m1t3c, m2t3c, m3t3c, m4t3c, type="text")
#SDH: I'm not too sure why it's throwing out the error it is. 
```




```{r table3_p-values}
#get p-values and manually insert into stargazer command in previous chunk

linearHypothesis(m1_t3,c("w_d"="ws_plus_d"))
linearHypothesis(m2_t3,c("w_d"="ws_plus_d"))
linearHypothesis(m3_t3,c("w_d"="ws_plus_d"))
linearHypothesis(m4_t3,c("w_d"="ws_plus_d"))

```


```{r table4_reproduction}

#TABLE4

m1_t4 <- lm(b4_t ~ ws_d + ws_plus_d + nomiss_bs_c4 + missd_bs_c4 + as.factor(location_f) + as.factor(round), data = final_data2)
summary(m1_t4)

m2_t4 <- lm(b4_t ~ ws_d + ws_plus_d + nomiss_bs_c4 + missd_bs_c4 +
            educ_yr + age_yr + female_d + bs_b15a +
            lang_xhosa_d + lang_venda_d + lang_zulu_d +
            as.factor(location_f) + as.factor(round), data = final_data2)
summary(m2_t4)

m3_t4 <- lm(b6_t ~ ws_d + ws_plus_d + nomiss_bs_c6 + missd_bs_c6 + 
              as.factor(location_f) + as.factor(round), data = final_data2)
summary(m3_t4)
  

m4_t4 <- lm(b6_t ~ ws_d + ws_plus_d + nomiss_bs_c6 + missd_bs_c6 +
             educ_yr + age_yr + female_d + bs_b15a +
             lang_xhosa_d + lang_venda_d + lang_zulu_d +
             as.factor(location_f) + as.factor(round), data = final_data2)
summary(m4_t4)


m5_t4 <- lm(a1_t ~ ws_d + ws_plus_d +
             as.factor(location_f) + as.factor(round), data = final_data2)
summary(m5_t4)
  

m6_t4 <- lm(a1_t ~ ws_d + ws_plus_d + educ_yr + age_yr + female_d + bs_b15a +
            lang_xhosa_d + lang_venda_d + lang_zulu_d +
            as.factor(location_f) + as.factor(round), data = final_data2)
summary(m6_t4)

stargazer(m1_t4,m2_t4,m3_t4,m4_t4, m5_t4, m6_t4, keep = c("ws_d","ws_plus_d"), keep.stat = c("n","rsq"), type = "text", column.labels = c("Responses", "Responses", "Offers", "Offers","Employed", "Employed"), covariate.labels =c("WS basic", "WS plus"), title="Table 4--EFFECTS ON EMPLOYMENT OUTCOMES",
          add.lines = 
            list(c("Covariates", "No", "Yes", "No", "Yes", "No", "Yes"),
          
          c("p-value","0.01505*","0.02838*", "", "", "0.007805**", "0.005438**")))

```

```{r table4_p-values, eval = FALSE}
#get p-values and manually insert into stargazer command in previous chunk

linearHypothesis(m1_t4,c("ws_d"="ws_plus_d"))
linearHypothesis(m2_t4,c("ws_d"="ws_plus_d"))
linearHypothesis(m3_t4,c("ws_d"="ws_plus_d"), singular.ok = TRUE) #error
linearHypothesis(m4_t4,c("ws_d"="ws_plus_d")) #same error
linearHypothesis(m5_t4,c("ws_d"="ws_plus_d"))
linearHypothesis(m6_t4,c("ws_d"="ws_plus_d"))
```